function MyNewSweeper(s){s.classes=$.extend({},defaults.classes,s.classes),gOpts=$.extend({},defaults,s),gOpts.init(),geraCampo(),geraMinas(),geraVizinhanca(),updateCellsToWin(),$("."+gOpts.classes.allCells.split(" ").join(".")).on("mousedown",function(s){var e=$(this),n=e.attr("x"),t=e.attr("y");switch(gOpts.onClick(),event.which){case 1:teste(function(){console.log("Left Click on ",n,t)}),clickLeft(n,t);break;case 2:break;case 3:teste(function(){console.log("Right Click on: ",n,t)}),clickRight(n,t)}}),$(gOpts.gameSelector).attr("oncontextmenu","return false;")}function teste(s){TEST&&s()}function clickRight(s,e){campoMatrix[s][e]==SAFE||campoMatrix[s][e]==MINE?(teste(function(){console.log("Adding FLAG")}),campoMatrix[s][e]+=FLAG,selectCell(s,e).removeClass(gOpts.classes.hidden).addClass(gOpts.classes.flag)):campoMatrix[s][e]!=REVELADO&&(teste(function(){console.log("Removing FLAG")}),campoMatrix[s][e]-=FLAG,selectCell(s,e).removeClass(gOpts.classes.flag).addClass(gOpts.classes.hidden))}function clickLeft(s,e){return campoMatrix[s][e]==MINE?(revealMines(),selectCell(s,e).removeClass(gOpts.classes.mine).addClass(gOpts.classes.clickedMine),void gOpts.onGameOver()):void(campoMatrix[s][e]!=FLAG+SAFE&&campoMatrix[s][e]!=FLAG+MINE&&campoMatrix[s][e]!=REVELADO&&revelarClicado(s,e))}function revealMines(){for(var s=0;s<gOpts.numRows;s++)for(var e=0;e<gOpts.numColumns;e++)campoMatrix[s][e]==MINE?selectCell(s,e).removeClass(gOpts.classes.hidden).addClass(gOpts.classes.mine):campoMatrix[s][e]==SAFE+FLAG&&selectCell(s,e).removeClass(gOpts.classes.hidden).addClass(gOpts.classes.wrongFlag)}function updateCellsToWin(){if(gOpts.cellsToWinMsg!==!1){var s={"#cellsToWin#":cellsToWin};$(gOpts.cellsSelector).text(replaceAll(gOpts.cellsToWinMsg,s))}0==cellsToWin&&gOpts.onWin()}function revelarClicado(s,e){cellsToWin--,campoMatrix[s][e]=REVELADO;var n=selectCell(s,e),t=n.attr(minasVizinhasAttr);n=n.removeClass(gOpts.classes.hidden).addClass(gOpts.classes.revealed),0!=t&&n.find("strong").text(t).css("color",gOpts.numberColors[t-1]),updateCellsToWin(),0==t&&abreVizinhos(s,e)}function abreVizinhos(s,e){for(var n=s-1;s+1>=n;n++)if(n>=0&&n<gOpts.numRows)for(var t=e-1;e+1>=t;t++)t>=0&&t<gOpts.numColumns&&campoMatrix[n][t]==SAFE&&revelarClicado(n,t)}function geraCampo(){teste(function(){console.log("Gerando Campo: ",gOpts.numRows,"x",gOpts.numColumns)});var s=$(gOpts.gameSelector);s.empty(),campoMatrix=[];for(var e=0;e<gOpts.numRows;e++){var n=$(gOpts.row).appendTo(s);campoMatrix[e]=[];for(var t=0;t<gOpts.numColumns;t++)campoMatrix[e][t]=SAFE,$(gOpts.cell).appendTo(n).attr("x",e).attr("y",t)}}function geraMinas(){if(isNaN(gOpts.numMines)){if(!dificulties.hasOwnProperty(gOpts.numMines))throw new Error("Incorrect numMines parameter. Use some number or some of the available dificulties");gOpts.numMines=gOpts.numRows*gOpts.numColumns*dificulties[gOpts.numMines]}else if(gOpts.numMines/(gOpts.numRows*gOpts.numColumns)>gOpts.mineLimit&&(gOpts.numMines=Math.floor(gOpts.numRows*gOpts.numColumns*gOpts.mineLimit),tooManyMinesMsg!==!1)){var s={"#percent#":100*gOpts.mineLimit+"%","#numberOfMines#":gOpts.numMines};gOpts.onExceedNumberOfMines(replaceAll(gOpts.tooManyMinesMsg,s))}cellsToWin=gOpts.numRows*gOpts.numColumns-gOpts.numMines,teste(function(){console.log("Gerando "+gOpts.numMines+" minas")});for(var e=0;e<gOpts.numMines;e++){var n,t;do n=randomIntFromInterval(0,gOpts.numRows-1),t=randomIntFromInterval(0,gOpts.numColumns-1);while(campoMatrix[n][t]!=SAFE);campoMatrix[n][t]=MINE,teste(function(){selectCell(n,t).removeClass(gOpts.classes.hidden).addClass(gOpts.classes.mine)})}}function geraVizinhanca(){for(var s=0;s<gOpts.numRows;s++)for(var e=0;e<gOpts.numColumns;e++)campoMatrix[s][e]==SAFE&&selectCell(s,e).attr(minasVizinhasAttr,contaMinasVizinhas(s,e))}function replaceAll(s,e){for(var n in e)s=s.replace(n,e[n]);return s}function contaMinasVizinhas(s,e){for(var n=0,t=s-1;s+1>=t;t++)if(t>=0&&t<gOpts.numRows)for(var a=e-1;e+1>=a;a++)a>=0&&a<gOpts.numColumns&&campoMatrix[t][a]==MINE&&n++;return n}function randomIntFromInterval(s,e){return Math.floor(Math.random()*(e-s+1)+s)}function selectCell(s,e){return $("."+gOpts.classes.allCells.split(" ").join(".")+'[x="'+s+'"][y="'+e+'"]')}var SAFE=0,MINE=1,FLAG=2,REVELADO=4,TEST=!1,dificulties={easy:.07,medium:.2,hard:.33,luckiest:.4},campoMatrix=[],gOpts,cellsToWin,minasVizinhasAttr="nm",defaults={gameSelector:"#game",cellsSelector:"#toWin",timeSelector:"#elapsedTime",numRows:12,numColumns:12,numMines:20,tooManyMinesMsg:"The number of mines can't exceed #percent# of the blocks. Using #numberOfMines# mines this round.",cellsToWinMsg:"#cellsToWin# remaining hidden cells.",classes:{rows:"row",flag:"btn-success",clickedMine:"btn-primary",hidden:"btn-info",mine:"btn-danger",revealed:"btn-default",wrongFlag:"btn-warning",allCells:"btn cell"},numberColors:["#421ecc","#c30f19","#42b60b","#d7a3c2","#cc38ba","#76471f","#1ddffb","#177a70"],mineLimit:.75,init:function(){this.row="<div class='"+this.classes.rows+"'></div>",this.cell="<div class='"+this.classes.allCells+" "+this.classes.hidden+"'><strong></strong></div>"},onGameOver:function(){alert("Game Over!")},onClick:function(){},onWin:function(){alert("You won!")},onExceedNumberOfMines:function(s){alert(s)}};
